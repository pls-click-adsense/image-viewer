<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>画像抽出くん（改良版）</title>
    <style>
        img { margin: 10px; border: 1px solid #ccc; vertical-align: top; }
        #result { display: flex; flex-wrap: wrap; }
    </style>
</head>
<body>
    <h2>URLを入れると画像を表示するよ</h2>
    <input type="text" id="urlInput" placeholder="https://example.com" style="width: 300px;">
    <button onclick="getImages()">画像を表示</button>
    <div id="result"></div>

    <script>
        async function getImages() {
            const url = document.getElementById('urlInput').value;
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = '読み込み中...'; 

            try {
                // allorigins というプロキシサービスを経由して、CORS制限を回避するよ
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl);
                
                if (!response.ok) throw new Error('読み込みに失敗しちゃった');
                
                const data = await response.json();
                const htmlString = data.contents; // サイトのHTMLの中身

                const parser = new DOMParser();
                const doc = parser.parseFromString(htmlString, 'text/html');
                const images = doc.querySelectorAll('img');

                resultDiv.innerHTML = ''; // メッセージをクリア

                if (images.length === 0) {
                    resultDiv.innerHTML = '画像が見つからなかったよ。';
                    return;
                }

                images.forEach(img => {
                    let src = img.getAttribute('src');
                    if (!src) return;

                    // 住所が途切れている（相対パス）場合に、元のURLをくっつけて補完する処理
                    if (!src.startsWith('http')) {
                        try {
                            const base = new URL(url);
                            src = new URL(src, base.origin).href;
                        } catch (e) {
                            return; 
                        }
                    }

                    const newImg = document.createElement('img');
                    newImg.src = src;
                    newImg.style.maxWidth = '200px';
                    resultDiv.appendChild(newImg);
                });

            } catch (e) {
                console.error(e);
                resultDiv.innerHTML = 'エラー：サイトの中身を読み取れませんでした。';
            }
        }
    </script>
</body>
</html>
